generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum Role {
  ADMIN
  ACCOUNTANT
}

enum SaleType {
  POS
  SALES_ORDER
}

enum OrderStatus {
  PENDING
  APPROVED
  DELIVERED
  CANCELLED
  INVOICED
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  CREDIT
}

enum StockMovementType {
  PURCHASE
  POS_SALE
  SALES_ORDER_RESERVE
  SALES_ORDER_DEDUCT
  MANUAL_ADJUSTMENT
}

//////////////////////////////////////////////////////
// USERS
//////////////////////////////////////////////////////

model User {
  id      String  @id
  name    String
  email   String  @unique
  role    Role
  storeId String?
  store   Store?  @relation(fields: [storeId], references: [id])

  purchases   Purchase[]
  sales       Sale[]
  salesOrders SalesOrder[]

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////////
// STORE
//////////////////////////////////////////////////////

model Store {
  id          String       @id @default(uuid())
  name        String
  location    String?
  users       User[]
  stocks      Stock[]
  sales       Sale[]
  salesOrders SalesOrder[]
  purchases   Purchase[]
  employees   Employee[]
  invoices    Invoice[]
  createdAt   DateTime     @default(now())
}

//////////////////////////////////////////////////////
// PRODUCT STRUCTURE
//////////////////////////////////////////////////////

model Brand {
  id          String     @id @default(uuid())
  name        String
  description String?
  categories  Category[]
  products    Product[]
}

model Category {
  id          String    @id @default(uuid())
  name        String
  description String?
  brandId     String
  brand       Brand     @relation(fields: [brandId], references: [id])
  series      Series[]
}

model Series {
  id          String    @id @default(uuid())
  name        String
  description String?
  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id])
  products    Product[]
}

model Product {
  id            String  @id @default(uuid())
  name          String
  brandId       String?
  seriesId      String?
  purchasePrice Float
  sellingPrice  Float

  brand  Brand?   @relation(fields: [brandId], references: [id])
  series Series?  @relation(fields: [seriesId], references: [id])

  stocks        Stock[]
  saleItems     SaleItem[]
  orderItems    SalesOrderItem[]
  purchaseItems PurchaseItem[]

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////////
// STOCK
//////////////////////////////////////////////////////

model Stock {
  id            String @id @default(uuid())
  storeId       String
  productId     String
  quantity      Int    @default(0)
  reservedQty   Int    @default(0)
  lowStockLevel Int    @default(5)

  store     Store           @relation(fields: [storeId], references: [id])
  product   Product         @relation(fields: [productId], references: [id])
  movements StockMovement[]

  updatedAt DateTime @updatedAt

  @@unique([storeId, productId])
}

model StockMovement {
  id          String            @id @default(uuid())
  stockId     String
  type        StockMovementType
  quantity    Int
  referenceId String?
  createdAt   DateTime          @default(now())

  stock Stock @relation(fields: [stockId], references: [id])
}

//////////////////////////////////////////////////////
// SUPPLIERS
//////////////////////////////////////////////////////

model Supplier {
  id          String     @id @default(uuid())
  name        String
  contactInfo String?
  purchases   Purchase[]
  createdAt   DateTime   @default(now())
}

//////////////////////////////////////////////////////
// PURCHASES
//////////////////////////////////////////////////////

model Purchase {
  id         String   @id @default(uuid())
  storeId    String
  supplierId String
  userId     String
  totalCost  Float
  createdAt  DateTime @default(now())

  store    Store    @relation(fields: [storeId], references: [id])
  supplier Supplier @relation(fields: [supplierId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  items PurchaseItem[]
}

model PurchaseItem {
  id         String @id @default(uuid())
  purchaseId String
  productId  String
  quantity   Int
  unitCost   Float
  totalCost  Float

  purchase Purchase @relation(fields: [purchaseId], references: [id])
  product  Product  @relation(fields: [productId], references: [id])
}

//////////////////////////////////////////////////////
// CUSTOMERS
//////////////////////////////////////////////////////

model Customer {
  id    String  @id @default(uuid())
  name  String
  phone String?
  email String?

  orders SalesOrder[]
  sales  Sale[]

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////////
// EMPLOYEES
//////////////////////////////////////////////////////

model Employee {
  id       String  @id @default(uuid())
  name     String
  storeId  String
  position String?

  store Store @relation(fields: [storeId], references: [id])

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////////
// POS SALES
//////////////////////////////////////////////////////

model Sale {
  id            String        @id @default(uuid())
  storeId       String
  userId        String
  customerId    String?
  totalAmount   Float
  paymentMethod PaymentMethod
  createdAt     DateTime      @default(now())

  store    Store     @relation(fields: [storeId], references: [id])
  user     User      @relation(fields: [userId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])

  items   SaleItem[]
  invoice Invoice?
}

model SaleItem {
  id        String @id @default(uuid())
  saleId    String
  productId String
  quantity  Int
  unitPrice Float
  total     Float

  sale    Sale    @relation(fields: [saleId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

//////////////////////////////////////////////////////
// SALES ORDERS
//////////////////////////////////////////////////////

model SalesOrder {
  id               String      @id @default(uuid())
  storeId          String
  userId           String
  customerId       String
  orderDate        DateTime    @default(now())
  expectedDelivery DateTime?
  status           OrderStatus
  totalAmount      Float

  store    Store    @relation(fields: [storeId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])

  items   SalesOrderItem[]
  invoice Invoice?
}

model SalesOrderItem {
  id        String @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  unitPrice Float
  total     Float

  order   SalesOrder @relation(fields: [orderId], references: [id])
  product Product    @relation(fields: [productId], references: [id])
}

//////////////////////////////////////////////////////
// INVOICES
//////////////////////////////////////////////////////

model Invoice {
  id            String         @id @default(uuid())
  storeId       String
  saleId        String?        @unique
  salesOrderId  String?        @unique
  totalAmount   Float
  paymentMethod PaymentMethod?
  createdAt     DateTime       @default(now())

  store      Store       @relation(fields: [storeId], references: [id])
  sale       Sale?       @relation(fields: [saleId], references: [id])
  salesOrder SalesOrder? @relation(fields: [salesOrderId], references: [id])
}
